# æ˜¥é…’æŠ½çç³»çµ± - å®Œæ•´å¯¦ä½œè¨ˆåŠƒï¼ˆ0 æˆæœ¬ç‰ˆæœ¬ï¼‰

## ç³»çµ±æ¦‚è¿°

ä¸€å€‹æ”¯æ´é›™è§’è‰²æ¬Šé™çš„å³æ™‚æŠ½çç³»çµ±ï¼Œä½¿ç”¨ WebSocket é€²è¡Œå³æ™‚é€šçŸ¥ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- **ä¸‰ç¨®å‰ç«¯é é¢**
  - **å¾Œå°ç®¡ç†**ï¼šæ–°å¢å“¡å·¥/çé …ã€æŸ¥çœ‹çµ±è¨ˆ
  - **æŠ½çæ“ä½œ**ï¼šä¸»æŒäººåŸ·è¡ŒæŠ½ç
  - **å¤§è¢å¹•å±•ç¤º**ï¼šå³æ™‚é¡¯ç¤ºä¸­çåå–®çµ¦å…¨å ´è§€çœ¾
- **æ‰¹æ¬¡æŠ½ç**ï¼šä¸€æ¬¡æŠ½ N å€‹äººï¼ˆä¾‹å¦‚ï¼š100000 å…ƒæŠ½ 5 å€‹äººï¼‰
- **ä¸€éµæŠ½ç**ï¼šä¸»æŒäººæŒ‰ä¸‹æŒ‰éˆ•ï¼Œå¾Œç«¯è‡ªå‹•éš¨æ©ŸæŠ½å‡ºä¸­çå“¡å·¥
- **é›™è§’è‰²æ©Ÿåˆ¶**
  - è§’è‰² Aï¼šå¯æŠ½æ‰€æœ‰çé …
  - è§’è‰² Bï¼šåƒ…å¯æŠ½è¬å…ƒä»¥ä¸‹çé …
- **ä¸€äººä¸€æ¬¡**ï¼šæ¯ä½å“¡å·¥åªèƒ½æŠ½çä¸€æ¬¡
- **å³æ™‚é€šçŸ¥**ï¼šWebSocket æ¨é€ä¸­ççµæœåˆ°æ‰€æœ‰é€£ç·šè£ç½®
- **å¾Œç«¯è¨˜éŒ„**ï¼šå®Œæ•´çš„æŠ½çæ­·å²èˆ‡é˜²é‡è¤‡æ©Ÿåˆ¶
- **éˆæ´»é…ç½®**ï¼šçé …èˆ‡å“¡å·¥æ•¸é‡å¯å‹•æ…‹èª¿æ•´

---

## æŠ€è¡“æ¶æ§‹ï¼ˆ0 æˆæœ¬æ–¹æ¡ˆï¼‰

### å¾Œç«¯æŠ€è¡“æ£§
- **Framework**: Node.js + Express
- **WebSocket**: Socket.io
- **Database**: **SQLite**ï¼ˆæª”æ¡ˆå‹è³‡æ–™åº«ï¼Œç„¡éœ€ä¼ºæœå™¨ï¼‰
- **ORM**: Prisma
- **éƒ¨ç½²**: Railway / Renderï¼ˆå…è²»æ–¹æ¡ˆï¼‰

### å‰ç«¯æŠ€è¡“æ£§
- **Framework**: React
- **WebSocket Client**: Socket.io-client
- **UI Library**: Ant Design
- **éƒ¨ç½²**: Vercel / Netlifyï¼ˆå…è²»ï¼‰

### æˆæœ¬åˆ†æ
| é …ç›® | æ–¹æ¡ˆ | è²»ç”¨ |
|------|------|------|
| è³‡æ–™åº« | SQLite | **å…è²»** |
| å¾Œç«¯éƒ¨ç½² | Railway/Render | **å…è²»** |
| å‰ç«¯éƒ¨ç½² | Vercel/Netlify | **å…è²»** |
| **ç¸½è¨ˆ** | | **NT$ 0** |

---

## è³‡æ–™åº«è¨­è¨ˆï¼ˆSQLiteï¼‰

### 1. employees (å“¡å·¥è¡¨)
```sql
CREATE TABLE employees (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  role_type TEXT NOT NULL,
  department TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2. prizes (çé …è¡¨)
```sql
CREATE TABLE prizes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  value INTEGER NOT NULL,
  quantity INTEGER NOT NULL,
  remaining INTEGER NOT NULL,
  image_url TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3. draw_records (æŠ½çè¨˜éŒ„è¡¨)
```sql
CREATE TABLE draw_records (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id TEXT UNIQUE NOT NULL,
  prize_id INTEGER NOT NULL,
  prize_name TEXT NOT NULL,
  prize_value INTEGER NOT NULL,
  drawn_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (employee_id) REFERENCES employees(employee_id),
  FOREIGN KEY (prize_id) REFERENCES prizes(id)
);
```

---

## Prisma Schemaï¼ˆSQLite ç‰ˆæœ¬ï¼‰

```prisma
datasource db {
  provider = "sqlite"
  url      = "file:./lottery.db"
}

generator client {
  provider = "prisma-client-js"
}

model Employee {
  id          Int          @id @default(autoincrement())
  employeeId  String       @unique @map("employee_id")
  name        String
  roleType    String       @map("role_type")
  department  String?
  createdAt   DateTime     @default(now()) @map("created_at")
  drawRecord  DrawRecord?
}

model Prize {
  id          Int          @id @default(autoincrement())
  name        String
  value       Int
  quantity    Int
  remaining   Int
  imageUrl    String?      @map("image_url")
  createdAt   DateTime     @default(now()) @map("created_at")
  drawRecords DrawRecord[]
}

model DrawRecord {
  id         Int      @id @default(autoincrement())
  employeeId String   @unique @map("employee_id")
  prizeId    Int      @map("prize_id")
  prizeName  String   @map("prize_name")
  prizeValue Int      @map("prize_value")
  drawnAt    DateTime @default(now()) @map("drawn_at")

  employee   Employee @relation(fields: [employeeId], references: [employeeId])
  prize      Prize    @relation(fields: [prizeId], references: [id])
}
```

---

## API è¨­è¨ˆ

### WebSocket äº‹ä»¶ï¼ˆä¸»è¦ï¼‰

#### Client -> Server
```javascript
socket.emit('join_hall')                    // è¨‚é–±å¤§å»³
socket.emit('draw', { employeeId: 'E001' }) // åŸ·è¡ŒæŠ½ç
```

#### Server -> Client
```javascript
// ä¸­ççµæœï¼ˆå€‹äººï¼‰
socket.on('draw_result', {
  success: true,
  employee: { id: 'E001', name: 'å¼µä¸‰', roleType: 'A' },
  prize: { id: 1, name: 'iPhone 15', value: 30000 }
})

// å…¨å ´å»£æ’­
socket.on('winner_announced', {
  employee: { id: 'E001', name: 'å¼µä¸‰' },
  prize: { name: 'iPhone 15', value: 30000 },
  timestamp: '2026-01-14T10:30:00Z'
})

// éŒ¯èª¤é€šçŸ¥
socket.on('draw_error', { message: 'æ‚¨å·²ç¶“æŠ½éçäº†' })
```

### REST API

#### å¾Œå°ç®¡ç† API
```
POST   /api/employees/batch           # æ‰¹é‡åŒ¯å…¥å“¡å·¥
GET    /api/employees                 # å–å¾—æ‰€æœ‰å“¡å·¥
POST   /api/employees                 # æ–°å¢å–®ä¸€å“¡å·¥
DELETE /api/employees/:id             # åˆªé™¤å“¡å·¥

POST   /api/prizes                    # æ–°å¢çé …
GET    /api/prizes                    # å–å¾—æ‰€æœ‰çé …
PUT    /api/prizes/:id                # æ›´æ–°çé …
DELETE /api/prizes/:id                # åˆªé™¤çé …

GET    /api/stats                     # çµ±è¨ˆè³‡è¨Š
POST   /api/reset                     # é‡ç½®æŠ½çè¨˜éŒ„
```

#### æŠ½ç API
```
POST   /api/draw/batch                # æ‰¹æ¬¡æŠ½çï¼ˆåƒæ•¸ï¼šcountï¼‰
GET    /api/draw/records              # æŸ¥è©¢æ‰€æœ‰ä¸­çè¨˜éŒ„
```

#### è¼”åŠ© API
```
GET    /api/health                    # å¥åº·æª¢æŸ¥
```

---

## æŠ½çé‚è¼¯

### å–®æ¬¡æŠ½çæµç¨‹

```
1. ä¸»æŒäººæŒ‰ä¸‹ã€Œé–‹å§‹æŠ½çã€æŒ‰éˆ•
   â†“
2. å¾Œç«¯éš¨æ©Ÿé¸å‡ºä¸€å€‹ã€Œé‚„æ²’æŠ½éççš„å“¡å·¥ã€
   - å¦‚æœæ‰€æœ‰å“¡å·¥éƒ½æŠ½é â†’ å›å‚³ã€Œæ‰€æœ‰å“¡å·¥éƒ½å·²æŠ½éçã€
   â†“
3. æ ¹æ“šè©²å“¡å·¥è§’è‰²ç¯©é¸å¯æŠ½çé …
   - è§’è‰² A: æ‰€æœ‰çé …ï¼ˆremaining > 0ï¼‰
   - è§’è‰² B: åƒ¹å€¼ â‰¤ 10000 çš„çé …ï¼ˆremaining > 0ï¼‰
   â†“
4. æª¢æŸ¥æ˜¯å¦æœ‰å¯æŠ½çé …
   - æœ‰çå“ â†’ åŸ·è¡Œæ­¥é©Ÿ 5
   - æ²’çå“ â†’ å›å‚³ã€ŒğŸ¤ è«‹å¤§å–Šè€é—†åŠ ç¢¼ï¼ã€
   â†“
5. éš¨æ©ŸæŠ½é¸çå“ï¼ˆå‡ç­‰æ©Ÿç‡ï¼‰
   â†“
6. äº¤æ˜“å¼å¯«å…¥è³‡æ–™åº«
   - æ‰£æ¸› remaining
   - æ–°å¢ draw_recordsï¼ˆUNIQUE é˜²é‡è¤‡ï¼‰
   â†“
7. WebSocket æ¨é€åˆ°æ‰€æœ‰é€£ç·šè£ç½®
   - ä¸»æŒäººç•«é¢é¡¯ç¤ºä¸­çè€…
   - å¤§è¢å¹•/è§€çœ¾ç•«é¢åŒæ­¥é¡¯ç¤º
```

### æ‰¹æ¬¡æŠ½çæµç¨‹

```
ä¸»æŒäººè¨­å®šï¼šä¸€æ¬¡æŠ½ 5 å€‹äºº
   â†“
é»æ“Šã€Œé–‹å§‹æ‰¹æ¬¡æŠ½çã€
   â†“
å¾Œç«¯åŸ·è¡Œè¿´åœˆï¼ˆæœ€å¤š 5 æ¬¡ï¼‰ï¼š
   æ¯æ¬¡åŸ·è¡Œï¼š
   1. éš¨æ©Ÿé¸ä¸€å€‹é‚„æ²’ä¸­ççš„å“¡å·¥
   2. æ ¹æ“šè§’è‰²ç¯©é¸å¯æŠ½çé …
   3. å¦‚æœæœ‰çå“ â†’ æŠ½çä¸¦è¨˜éŒ„
   4. å¦‚æœæ²’çå“ â†’ è·³éï¼Œé¡¯ç¤ºã€Œè€é—†åŠ ç¢¼ã€
   5. å¦‚æœæ²’æœ‰æœªä¸­çå“¡å·¥ â†’ åœæ­¢
   â†“
å›å‚³ä¸­ççµæœé™£åˆ—
   â†“
WebSocket æ¨é€æ‰€æœ‰çµæœ
   â†“
å¤§è¢å¹•ä¾åºå±•ç¤ºï¼ˆå¯åŠ å‹•ç•«æ•ˆæœï¼‰
```

**ç¯„ä¾‹**ï¼š
```javascript
// è«‹æ±‚
POST /api/draw/batch
{ "count": 5 }

// å›æ‡‰
{
  "success": true,
  "results": [
    { "employee": {...}, "prize": {...} },
    { "employee": {...}, "prize": {...} },
    { "employee": {...}, "prize": {...} },
    { "success": false, "message": "è«‹å¤§å–Šè€é—†åŠ ç¢¼", "employee": {...} },
    { "employee": {...}, "prize": {...} }
  ],
  "summary": {
    "total": 5,
    "succeeded": 4,
    "failed": 1
  }
}
```

### ç‰¹æ®Šæƒ…æ³è™•ç†

#### æƒ…æ³ 1ï¼šæ­£å¸¸ä¸­ç âœ…
```json
{
  "success": true,
  "employee": { "id": "E001", "name": "å¼µä¸‰", "roleType": "A" },
  "prize": { "id": 1, "name": "iPhone 15", "value": 30000 }
}
```

#### æƒ…æ³ 2ï¼šçå“å·²æŠ½å®Œï¼ˆè€é—†åŠ ç¢¼å½©è›‹ï¼‰ğŸ¤
```json
{
  "success": false,
  "message": "ğŸ¤ è«‹å¤§å–Šè€é—†åŠ ç¢¼ï¼",
  "employee": { "id": "E002", "name": "æå››", "roleType": "B" },
  "reason": "no_available_prizes"
}
```
**ç™¼ç”Ÿæ™‚æ©Ÿ**ï¼š
- æ‰€æœ‰çå“éƒ½æŠ½å®Œäº†
- æˆ–è©²å“¡å·¥è§’è‰²åªèƒ½æŠ½è¬å…ƒä»¥ä¸‹ï¼Œä½†å‰©ä¸‹çš„éƒ½æ˜¯è¬å…ƒä»¥ä¸Šçå“

#### æƒ…æ³ 3ï¼šæ‰€æœ‰äººéƒ½æŠ½éäº† ğŸ‰
```json
{
  "success": false,
  "message": "æ‰€æœ‰å“¡å·¥éƒ½å·²ç¶“æŠ½éçäº†ï¼",
  "reason": "all_drawn"
}
```

---

## å‰ç«¯é é¢æ¶æ§‹

### 1. å¾Œå°ç®¡ç†é é¢ï¼ˆ/adminï¼‰

**åŠŸèƒ½**ï¼š
- å“¡å·¥ç®¡ç†
  - æ‰¹æ¬¡åŒ¯å…¥ CSV
  - æ–°å¢/åˆªé™¤å“¡å·¥
  - æŸ¥çœ‹å“¡å·¥åˆ—è¡¨ï¼ˆé¡¯ç¤ºè§’è‰²é¡å‹ï¼‰
- çé …ç®¡ç†
  - æ–°å¢çé …ï¼ˆåç¨±ã€åƒ¹å€¼ã€æ•¸é‡ï¼‰
  - ç·¨è¼¯/åˆªé™¤çé …
  - æŸ¥çœ‹çé …åˆ—è¡¨ï¼ˆé¡¯ç¤ºå‰©é¤˜æ•¸é‡ï¼‰
- çµ±è¨ˆå„€è¡¨æ¿
  - ç¸½å“¡å·¥æ•¸ / å·²æŠ½çäººæ•¸
  - çå“ç¸½æ•¸ / å‰©é¤˜æ•¸é‡
  - å·²åˆ†é…çå“ç¸½åƒ¹å€¼
- ç³»çµ±ç®¡ç†
  - é‡ç½®æŠ½çè¨˜éŒ„
  - åŒ¯å‡ºä¸­çåå–®

**è·¯ç”±**ï¼š`/admin`

### 2. æŠ½çæ“ä½œé é¢ï¼ˆ/drawï¼‰

**åŠŸèƒ½**ï¼š
- å–®æ¬¡æŠ½ç
  - å¤§æŒ‰éˆ•ã€Œé–‹å§‹æŠ½çã€
  - é¡¯ç¤ºæœ¬æ¬¡ä¸­ççµæœ
- æ‰¹æ¬¡æŠ½ç
  - è¼¸å…¥æ¡†ï¼šä¸€æ¬¡æŠ½å¹¾å€‹äºº
  - æŒ‰éˆ•ã€Œé–‹å§‹æ‰¹æ¬¡æŠ½çã€
  - é¡¯ç¤ºæœ¬æ‰¹æ¬¡æ‰€æœ‰ä¸­ççµæœ
- å³æ™‚ç‹€æ…‹
  - å‰©é¤˜å¯æŠ½çäººæ•¸
  - å‰©é¤˜çå“æ•¸é‡
  - å·²æŠ½å‡ºçå“ç¸½åƒ¹å€¼

**è·¯ç”±**ï¼š`/draw`

### 3. å¤§è¢å¹•å±•ç¤ºé é¢ï¼ˆ/displayï¼‰

**åŠŸèƒ½**ï¼š
- å³æ™‚ä¸­çæ’­å ±
  - è‡ªå‹•æ»¾å‹•é¡¯ç¤ºæœ€æ–°ä¸­çè€…
  - å¤§å­—é«”é¡¯ç¤ºå“¡å·¥å§“åã€çå“åç¨±
  - å‹•ç•«æ•ˆæœï¼ˆç…™ç«ã€å½©å¸¶ï¼‰
- ä¸­çåå–®
  - å®Œæ•´çš„ä¸­çç´€éŒ„
  - è‡ªå‹•æ’åºï¼ˆæœ€æ–°åœ¨æœ€ä¸Šé¢ï¼‰
- çµ±è¨ˆè³‡è¨Šï¼ˆå¯é¸ï¼‰
  - å·²æŠ½å‡ºå¹¾äºº
  - å‰©é¤˜å¹¾å€‹çå“

**è·¯ç”±**ï¼š`/display`

**ç‰¹æ€§**ï¼š
- å…¨è¢å¹•æ¨¡å¼
- è‡ªå‹•æ›´æ–°ï¼ˆWebSocketï¼‰
- åªè®€ï¼Œç„¡æ“ä½œåŠŸèƒ½

### è·¯ç”±è¨­è¨ˆ

```typescript
// App.tsx
import { BrowserRouter, Routes, Route } from 'react-router-dom'

<BrowserRouter>
  <Routes>
    <Route path="/" element={<HomePage />} />           // é¸æ“‡å…¥å£
    <Route path="/admin" element={<AdminPage />} />     // å¾Œå°ç®¡ç†
    <Route path="/draw" element={<DrawPage />} />       // æŠ½çæ“ä½œ
    <Route path="/display" element={<DisplayPage />} /> // å¤§è¢å¹•å±•ç¤º
  </Routes>
</BrowserRouter>
```

---

## å¯¦ä½œæ­¥é©Ÿ

### Step 1: åˆå§‹åŒ–å°ˆæ¡ˆï¼ˆ20 åˆ†é˜ï¼‰

#### 1.1 å¾Œç«¯åˆå§‹åŒ–
```bash
mkdir lottery-backend
cd lottery-backend
npm init -y
npm install express socket.io @prisma/client cors dotenv
npm install -D typescript @types/node @types/express @types/cors ts-node nodemon prisma

npx tsc --init
npx prisma init --datasource-provider sqlite
```

#### 1.2 ç·¨è¼¯ Prisma Schema

å°‡ `prisma/schema.prisma` æ”¹ç‚ºï¼š
```prisma
datasource db {
  provider = "sqlite"
  url      = "file:./lottery.db"
}

// ... å…¶ä»–å…§å®¹å¦‚å‰é¢çš„ schema
```

åŸ·è¡Œé·ç§»ï¼š
```bash
npx prisma migrate dev --name init
npx prisma generate
```

é€™æœƒåœ¨ `prisma/` ç›®éŒ„ä¸‹ç”¢ç”Ÿ `lottery.db` æª”æ¡ˆã€‚

#### 1.3 å‰ç«¯åˆå§‹åŒ–
```bash
npx create-react-app lottery-frontend --template typescript
cd lottery-frontend
npm install socket.io-client antd
```

---

### Step 2: å¾Œç«¯æ ¸å¿ƒé–‹ç™¼ï¼ˆ3 å°æ™‚ï¼‰

**å°ˆæ¡ˆçµæ§‹**
```
lottery-backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ drawService.ts
â”‚       â””â”€â”€ socketService.ts
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma
â”‚   â””â”€â”€ lottery.db        # SQLite è³‡æ–™åº«æª”æ¡ˆ
â”œâ”€â”€ .env
â””â”€â”€ package.json
```

#### 2.1 æŠ½çæœå‹™

**src/services/drawService.ts**
```typescript
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

export class DrawService {
  async hasDrawn(employeeId: string): Promise<boolean> {
    const record = await prisma.drawRecord.findUnique({
      where: { employeeId }
    })
    return !!record
  }

  async getEmployee(employeeId: string) {
    const employee = await prisma.employee.findUnique({
      where: { employeeId }
    })

    if (!employee) {
      throw new Error('å“¡å·¥ç·¨è™Ÿä¸å­˜åœ¨')
    }

    return employee
  }

  async getAvailablePrizes(roleType: string) {
    let prizes = await prisma.prize.findMany({
      where: { remaining: { gt: 0 } }
    })

    if (roleType === 'B') {
      prizes = prizes.filter(p => p.value <= 10000)
    }

    return prizes
  }

  async executeDraw(employeeId: string) {
    const employee = await this.getEmployee(employeeId)

    if (await this.hasDrawn(employeeId)) {
      throw new Error('æ‚¨å·²ç¶“æŠ½éçäº†')
    }

    const availablePrizes = await this.getAvailablePrizes(employee.roleType)

    if (availablePrizes.length === 0) {
      throw new Error('ç›®å‰æ²’æœ‰å¯æŠ½çš„çé …')
    }

    const selectedPrize = availablePrizes[
      Math.floor(Math.random() * availablePrizes.length)
    ]

    const result = await prisma.$transaction(async (tx) => {
      await tx.prize.update({
        where: { id: selectedPrize.id },
        data: { remaining: { decrement: 1 } }
      })

      await tx.drawRecord.create({
        data: {
          employeeId: employee.employeeId,
          prizeId: selectedPrize.id,
          prizeName: selectedPrize.name,
          prizeValue: selectedPrize.value
        }
      })

      return {
        employee: {
          id: employee.employeeId,
          name: employee.name,
          roleType: employee.roleType
        },
        prize: {
          id: selectedPrize.id,
          name: selectedPrize.name,
          value: selectedPrize.value,
          imageUrl: selectedPrize.imageUrl
        }
      }
    })

    return result
  }
}
```

#### 2.2 WebSocket æœå‹™

**src/services/socketService.ts**
```typescript
import { Server, Socket } from 'socket.io'
import { DrawService } from './drawService'

export class SocketService {
  private io: Server
  private drawService: DrawService

  constructor(io: Server) {
    this.io = io
    this.drawService = new DrawService()
    this.initialize()
  }

  private initialize() {
    this.io.on('connection', (socket: Socket) => {
      console.log(`âœ… Client connected: ${socket.id}`)

      socket.on('join_hall', () => {
        socket.join('lottery_hall')
      })

      socket.on('draw', async (data: { employeeId: string }) => {
        try {
          const result = await this.drawService.executeDraw(data.employeeId)

          socket.emit('draw_result', { success: true, ...result })

          this.io.to('lottery_hall').emit('winner_announced', {
            employee: result.employee,
            prize: result.prize,
            timestamp: new Date().toISOString()
          })

        } catch (error: any) {
          socket.emit('draw_error', { message: error.message })
        }
      })

      socket.on('disconnect', () => {
        console.log(`âŒ Client disconnected: ${socket.id}`)
      })
    })
  }
}
```

#### 2.3 ä¸»å…¥å£

**src/index.ts**
```typescript
import express from 'express'
import { createServer } from 'http'
import { Server } from 'socket.io'
import cors from 'cors'
import { SocketService } from './services/socketService'

const app = express()
const httpServer = createServer(app)
const io = new Server(httpServer, {
  cors: {
    origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
    methods: ['GET', 'POST']
  }
})

app.use(cors())
app.use(express.json())

new SocketService(io)

app.get('/api/health', (req, res) => {
  res.json({ status: 'ok' })
})

const PORT = process.env.PORT || 3001

httpServer.listen(PORT, () => {
  console.log(`ğŸš€ Server running on port ${PORT}`)
})
```

#### 2.4 é…ç½®

**package.json scripts**
```json
{
  "scripts": {
    "dev": "nodemon --exec ts-node src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  }
}
```

**tsconfig.json**
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  }
}
```

**.env**
```env
DATABASE_URL="file:./lottery.db"
PORT=3001
CORS_ORIGIN=http://localhost:3000
```

---

### Step 3: å‰ç«¯é–‹ç™¼ï¼ˆ3 å°æ™‚ï¼‰

#### 3.1 WebSocket æœå‹™

**src/services/socket.ts**
```typescript
import { io, Socket } from 'socket.io-client'

class SocketService {
  private socket: Socket | null = null

  connect(url: string = 'http://localhost:3001') {
    this.socket = io(url)

    this.socket.on('connect', () => {
      console.log('âœ… Connected')
      this.socket?.emit('join_hall')
    })

    return this.socket
  }

  draw(employeeId: string) {
    this.socket?.emit('draw', { employeeId })
  }

  onDrawResult(callback: (data: any) => void) {
    this.socket?.on('draw_result', callback)
  }

  onWinnerAnnounced(callback: (data: any) => void) {
    this.socket?.on('winner_announced', callback)
  }

  onError(callback: (data: any) => void) {
    this.socket?.on('draw_error', callback)
  }

  disconnect() {
    this.socket?.disconnect()
  }
}

export default new SocketService()
```

#### 3.2 æŠ½çé¢æ¿

**src/components/DrawPanel.tsx**
```typescript
import React, { useState, useEffect } from 'react'
import { Input, Button, Card, message, Modal } from 'antd'
import { GiftOutlined } from '@ant-design/icons'
import socketService from '../services/socket'

export const DrawPanel: React.FC = () => {
  const [employeeId, setEmployeeId] = useState('')
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    socketService.onDrawResult((data) => {
      setLoading(false)

      Modal.success({
        title: 'ğŸ‰ æ­å–œä¸­çï¼',
        width: 500,
        content: (
          <div style={{ textAlign: 'center', padding: '20px' }}>
            <h2>{data.employee.name} ({data.employee.id})</h2>
            <div style={{
              fontSize: 28,
              color: '#ff4d4f',
              fontWeight: 'bold',
              margin: '20px 0'
            }}>
              {data.prize.name}
            </div>
            <p style={{ fontSize: 18 }}>
              åƒ¹å€¼ï¼šNT$ {data.prize.value.toLocaleString()}
            </p>
          </div>
        ),
        onOk: () => setEmployeeId('')
      })
    })

    socketService.onError((data) => {
      setLoading(false)
      message.error(data.message)
    })
  }, [])

  const handleDraw = () => {
    if (!employeeId.trim()) {
      message.warning('è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ')
      return
    }

    setLoading(true)
    socketService.draw(employeeId)
  }

  return (
    <Card
      title={<><GiftOutlined /> æ˜¥é…’æŠ½ç</>}
      style={{ maxWidth: 500, margin: '40px auto' }}
    >
      <Input
        placeholder="è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿï¼ˆä¾‹å¦‚ï¼šE001ï¼‰"
        value={employeeId}
        onChange={(e) => setEmployeeId(e.target.value.toUpperCase())}
        onPressEnter={handleDraw}
        size="large"
        style={{ marginBottom: 16 }}
        disabled={loading}
      />
      <Button
        type="primary"
        block
        size="large"
        loading={loading}
        onClick={handleDraw}
        icon={<GiftOutlined />}
      >
        {loading ? 'æŠ½çä¸­...' : 'é–‹å§‹æŠ½ç'}
      </Button>
    </Card>
  )
}
```

#### 3.3 ä¸­ççœ‹æ¿

**src/components/WinnerBoard.tsx**
```typescript
import React, { useState, useEffect } from 'react'
import { Card, List, Avatar, Tag, Empty } from 'antd'
import { TrophyOutlined } from '@ant-design/icons'
import socketService from '../services/socket'

interface Winner {
  employee: { id: string; name: string }
  prize: { name: string; value: number }
  timestamp: string
}

export const WinnerBoard: React.FC = () => {
  const [winners, setWinners] = useState<Winner[]>([])

  useEffect(() => {
    socketService.onWinnerAnnounced((data: Winner) => {
      setWinners((prev) => [data, ...prev])
    })
  }, [])

  return (
    <Card
      title={<><TrophyOutlined /> å³æ™‚ä¸­çåå–®</>}
      style={{ maxWidth: 800, margin: '20px auto' }}
    >
      {winners.length === 0 ? (
        <Empty description="å°šç„¡ä¸­çè¨˜éŒ„" />
      ) : (
        <List
          dataSource={winners}
          renderItem={(item) => (
            <List.Item>
              <List.Item.Meta
                avatar={
                  <Avatar style={{ backgroundColor: '#f56a00' }}>
                    {item.employee.name[0]}
                  </Avatar>
                }
                title={
                  <span>
                    {item.employee.name} <Tag>{item.employee.id}</Tag>
                  </span>
                }
                description={
                  <>
                    <Tag color="red">{item.prize.name}</Tag>
                    NT$ {item.prize.value.toLocaleString()}
                  </>
                }
              />
            </List.Item>
          )}
        />
      )}
    </Card>
  )
}
```

#### 3.4 ä¸»æ‡‰ç”¨

**src/App.tsx**
```typescript
import React, { useEffect } from 'react'
import { DrawPanel } from './components/DrawPanel'
import { WinnerBoard } from './components/WinnerBoard'
import socketService from './services/socket'
import 'antd/dist/reset.css'

function App() {
  useEffect(() => {
    socketService.connect()
    return () => socketService.disconnect()
  }, [])

  return (
    <div style={{ padding: 20, background: '#f0f2f5', minHeight: '100vh' }}>
      <h1 style={{ textAlign: 'center', marginBottom: 40 }}>
        ğŸŠ 2026 æ˜¥é…’æŠ½çç³»çµ±
      </h1>
      <DrawPanel />
      <WinnerBoard />
    </div>
  )
}

export default App
```

---

### Step 4: è³‡æ–™æº–å‚™ï¼ˆ30 åˆ†é˜ï¼‰

#### 4.1 å“¡å·¥è³‡æ–™åŒ¯å…¥

**scripts/import-employees.ts**
```typescript
import { PrismaClient } from '@prisma/client'
import * as fs from 'fs'
import csvParser from 'csv-parser'

const prisma = new PrismaClient()

async function importEmployees(csvPath: string) {
  const employees: any[] = []

  fs.createReadStream(csvPath)
    .pipe(csvParser())
    .on('data', (row) => {
      employees.push({
        employeeId: row['å“¡å·¥ç·¨è™Ÿ'],
        name: row['å§“å'],
        roleType: row['è§’è‰²é¡å‹'],
        department: row['éƒ¨é–€'] || null
      })
    })
    .on('end', async () => {
      await prisma.employee.createMany({
        data: employees,
        skipDuplicates: true
      })
      console.log(`âœ… åŒ¯å…¥ ${employees.length} ä½å“¡å·¥`)
      await prisma.$disconnect()
    })
}

importEmployees('./employees.csv')
```

**employees.csv**
```csv
å“¡å·¥ç·¨è™Ÿ,å§“å,è§’è‰²é¡å‹,éƒ¨é–€
E001,å¼µä¸‰,A,è³‡è¨Šéƒ¨
E002,æå››,B,æ¥­å‹™éƒ¨
E003,ç‹äº”,B,è¡ŒéŠ·éƒ¨
```

åŸ·è¡Œï¼š
```bash
npm install csv-parser
npx ts-node scripts/import-employees.ts
```

#### 4.2 çé …è³‡æ–™

**scripts/seed-prizes.ts**
```typescript
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

const prizes = [
  { name: 'iPhone 15 Pro Max', value: 40000, quantity: 1 },
  { name: 'iPad Pro', value: 25000, quantity: 2 },
  { name: 'AirPods Pro', value: 7000, quantity: 5 },
  { name: 'Switch OLED', value: 9500, quantity: 4 },
  { name: 'æ˜Ÿå·´å…‹ 3000', value: 3000, quantity: 10 },
  { name: 'å…¨è¯ç¦®åˆ¸ 1000', value: 1000, quantity: 20 }
]

async function seedPrizes() {
  for (const prize of prizes) {
    await prisma.prize.create({
      data: { ...prize, remaining: prize.quantity }
    })
  }
  console.log('âœ… çé …å»ºç«‹å®Œæˆ')
  await prisma.$disconnect()
}

seedPrizes()
```

---

## å…è²»éƒ¨ç½²æ–¹æ¡ˆ

### å¾Œç«¯éƒ¨ç½²ï¼ˆRailway å…è²»æ–¹æ¡ˆï¼‰

1. è¨»å†Š Railway: https://railway.app/
2. é€£çµ GitHub Repo
3. è¨­å®šç’°å¢ƒè®Šæ•¸ï¼š
   ```
   DATABASE_URL=file:./lottery.db
   PORT=3001
   CORS_ORIGIN=https://your-frontend.vercel.app
   ```
4. **é‡è¦**ï¼šç¢ºä¿ `prisma/lottery.db` è¢« Git è¿½è¹¤ï¼š
   ```bash
   # ä¿®æ”¹ .gitignoreï¼Œç§»é™¤ *.db
   git add prisma/lottery.db
   git commit -m "Add database"
   ```

### å‰ç«¯éƒ¨ç½²ï¼ˆVercel å…è²»æ–¹æ¡ˆï¼‰

1. è¨»å†Š Vercel: https://vercel.com/
2. Import GitHub Repo
3. è¨­å®šç’°å¢ƒè®Šæ•¸ï¼š
   ```
   REACT_APP_SOCKET_URL=https://your-backend.railway.app
   ```
4. Deploy

---

## æœ¬åœ°å•Ÿå‹•

### å¾Œç«¯
```bash
cd lottery-backend
npm run dev
```

### å‰ç«¯
```bash
cd lottery-frontend
npm start
```

---

## å¸¸è¦‹å•é¡Œ

### Q1: SQLite èƒ½æ‰¿å—å¤šå°‘äººåŒæ™‚æŠ½çï¼Ÿ
**A:** 50-100 äººåŒæ™‚ä½¿ç”¨æ²’å•é¡Œã€‚å¦‚æœè¶…é 200 äººï¼Œå»ºè­°æ”¹ç”¨ PostgreSQLï¼ˆSupabase å…è²»æ–¹æ¡ˆï¼‰ã€‚

### Q2: Railway å…è²»æ–¹æ¡ˆæœ‰é™åˆ¶å—ï¼Ÿ
**A:**
- å…è²» 500 å°æ™‚/æœˆ
- ä¼‘çœ å¾Œéœ€è¦æ™‚é–“å†·å•Ÿå‹•ï¼ˆç´„ 10-30 ç§’ï¼‰
- é©åˆæ´»å‹•ç•¶å¤©ä½¿ç”¨

### Q3: è³‡æ–™æœƒä¸æœƒéºå¤±ï¼Ÿ
**A:**
- SQLite æª”æ¡ˆéœ€è¦ commit åˆ° Git
- æˆ–ä½¿ç”¨ Railway çš„ Volume åŠŸèƒ½æ›è¼‰æŒä¹…åŒ–å„²å­˜

### Q4: å¯ä»¥æ”¹ç”¨ Supabaseï¼ˆå…è²» PostgreSQLï¼‰å—ï¼Ÿ
**A:** å¯ä»¥ï¼åªéœ€ä¿®æ”¹ Prisma Schemaï¼š
```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```
ç„¶å¾Œä½¿ç”¨ Supabase çš„é€£ç·šå­—ä¸²ã€‚

---

## é‡ç½®æŠ½ç

```bash
# æ–¹æ³• 1ï¼šåˆªé™¤è³‡æ–™åº«é‡å»º
rm prisma/lottery.db
npx prisma migrate dev

# æ–¹æ³• 2ï¼šåŸ·è¡Œ SQL
npx prisma studio  # æ‰“é–‹è¦–è¦ºåŒ–ä»‹é¢æ‰‹å‹•æ¸…é™¤
```

---

## æª¢æŸ¥æ¸…å–®

- [ ] SQLite è³‡æ–™åº«å»ºç«‹æˆåŠŸ
- [ ] å“¡å·¥è³‡æ–™åŒ¯å…¥
- [ ] çé …è³‡æ–™å»ºç«‹
- [ ] WebSocket é€£ç·šæ­£å¸¸
- [ ] æŠ½çåŠŸèƒ½æ¸¬è©¦é€šé
- [ ] ä¸€äººåªèƒ½æŠ½ä¸€æ¬¡é©—è­‰
- [ ] è§’è‰²æ¬Šé™æ­£ç¢º
- [ ] å‰å¾Œç«¯éƒ¨ç½²å®Œæˆ

---

## æ™‚é–“é ä¼°

| éšæ®µ | æ™‚é–“ |
|------|------|
| åˆå§‹åŒ– | 20 åˆ†é˜ |
| å¾Œç«¯é–‹ç™¼ | 3 å°æ™‚ |
| å‰ç«¯é–‹ç™¼ | 3 å°æ™‚ |
| è³‡æ–™æº–å‚™ | 30 åˆ†é˜ |
| éƒ¨ç½²æ¸¬è©¦ | 1 å°æ™‚ |
| **ç¸½è¨ˆ** | **8 å°æ™‚** |

---

**å®Œå…¨å…è²»ï¼Œç¥æŠ½çé †åˆ©ï¼ğŸ‰**
